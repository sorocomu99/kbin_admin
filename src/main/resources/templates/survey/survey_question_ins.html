<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragment/config :: configFragment"></head>

<body>
<div class="wrap">
    <div th:replace="fragment/header :: headerFragment"></div>

    <main class="main">
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="paper">
                        <h2 class="h4">지원서 설문 관리 <span id="helpSurveyQuestion" class="help"><i class="mb-1"
                                                                                               data-feather="help-circle"></i></span>
                        </h2>
                    </div>
                    <form id="qstn_form" name="qstn_form" th:action="@{/survey/qstnInsert}" method="post">
                        <input type="hidden" name="survey_no" id="survey_no" th:value="${surveyNo}"/>
                        <input type="hidden" id="menu_id" name="menu_id" th:value="${menuId}"/>
                        <div class="question">
                            <!-- 문항 리스트 -->
                            <div th:each="row : ${questions}" class="question-list">
                                <div class="question-head">
                                    <h3 class="heading h5"><i data-feather="check-circle"></i> 문항
                                        <th:block th:text="${rowStat.index + 1}"></th:block>
                                    </h3>
                                    <select class="form-select select-type" name="question_type_no"
                                            onchange="changeType(this)">
                                        <option value="1" th:selected="${row.question_type_no == '1'}">객관식 질문</option>
                                        <option value="2" th:selected="${row.question_type_no == '2'}">주관식 질문</option>
                                        <option value="3" th:selected="${row.question_type_no == '3'}">첨부파일</option>
                                        <option value="4" th:selected="${row.question_type_no == '4'}">에디터</option>
                                    </select>
                                </div>
                                <div class="question-body" th:classappend="${row.question_type_no == '1' ? 'on' : ''}"
                                     data-question-type="1">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control" name="question_title"
                                                   th:value="${row.question_title}" placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control" rows="5"
                                                      name="question_description"
                                                      th:text="${row.question_description}"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div class="item-list">
                                                <div class="item" th:each="choice : ${row.choices}">
                                                    <input type="hidden" name="question_choice_no"
                                                           th:value="${choice.question_choice_no}"/>
                                                    <div class="column">
                                                        <input type="text" class="form-control form-control-sm"
                                                               name="choice_content" th:value="${choice.choice_content}"
                                                               th:placeholder="${'보기' + (choiceStat.index + 1)}">
                                                        <select class="form-select form-select-sm move-question-type">
                                                            <option value="0">다음 문항</option>
                                                            <option value="1">문항 번호 선택</option>
                                                            <option value="99">설문 제출</option>
                                                        </select>
                                                    </div>
                                                    <div class="column">
                                                        <button type="button" class="btn remove-item"
                                                                onclick="removeItem(this)"><i
                                                                data-feather="x-circle"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-dark add-item"
                                                    onclick="addItem(this)" data-idx="1">
                                                <i class="me-0" data-feather="plus"></i>
                                                보기 추가
                                            </button>
                                        </div>
                                    </div>

                                </div>
                                <div class="question-body" th:classappend="${row.question_type_no == '2' ? 'on' : ''}"
                                     data-question-type="2">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control" name="question_title"
                                                   th:value="${row.question_title}" placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control" name="question_description"
                                                      th:text="${row.question_description}" rows="5"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-body" th:classappend="${row.question_type_no == '3' ? 'on' : ''}"
                                     data-question-type="3">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control" name="question_title"
                                                   th:value="${row.question_title}" placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control" name="question_description" rows="5"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."
                                                      th:text="${row.question_description}"></textarea>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="d-flex align-items-center">
                                                <input class="form-control" type="file"
                                                       th:id="${'formFile' + (rowStat.index + 1)}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-body" th:classappend="${row.question_type_no == '4' ? 'on' : ''}"
                                     data-question-type="4">
                                    <div class="row">
                                        <div class="col">
                                            <!-- 에디터 -->
                                            <div class="summernote-editor"
                                                 th:id="${'summernote' + (rowStat.index + 1)}"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-foot">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch"
                                               th:id="${'required' + (rowStat.index + 1)}" name="required_yn">
                                        <label class="form-check-label" th:for="${'required' + (rowStat.index + 1)}">필수
                                            값 설정</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input move-question-switch" type="checkbox"
                                               role="switch"
                                               th:id="${'moveQuestion' + (rowStat.index + 1)}"
                                               onclick="toggleMove(this)">
                                        <label class="form-check-label"
                                               th:for="${'moveQuestion' + (rowStat.index + 1)}">문항
                                            이동</label>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-dark" onclick="removeList(this)"><i
                                            data-feather="trash-2"></i>문항 삭제
                                    </button>
                                </div>
                            </div>
                            <div th:if="${questions.size() < 10}" th:with="questionSize=${questions.size()}"
                                 class="question-list">
                                <div class="question-head">
                                    <h3 class="heading h5"><i data-feather="check-circle"></i> 문항
                                        <th:block th:text="${questionSize + 1}"></th:block>
                                    </h3>
                                    <select class="form-select select-type" name="question_type_no"
                                            onchange="changeType(this)">
                                        <option value="1" selected>객관식 질문</option>
                                        <option value="2">주관식 질문</option>
                                        <option value="3">첨부파일</option>
                                        <option value="4">에디터</option>
                                    </select>
                                </div>
                                <div class="question-body on" data-question-type="1">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control" name="question_title"
                                                   value="" placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control" rows="5"
                                                      name="question_description"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div class="item-list">
                                            </div>
                                            <button type="button" class="btn btn-sm btn-dark add-item"
                                                    onclick="addItem(this, 1)" data-idx="1">
                                                <i class="me-0" data-feather="plus"></i>
                                                보기 추가
                                            </button>
                                        </div>
                                    </div>

                                </div>
                                <div class="question-body" data-question-type="2">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control" name="question_title" value=""
                                                   placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control"
                                                      name="question_description" rows="5"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-body" data-question-type="3">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control" name="question_title" value=""
                                                   placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control"
                                                      name="question_description" rows="5"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-body" data-question-type="4">
                                    <div class="row">
                                        <div class="col">
                                            <div class="summernote-editor"
                                                 th:id="${'summernote' + (questionSize + 1)}"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-foot">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch"
                                               th:id="${'required' + (questionSize + 1)}"
                                               name="required_yn">
                                        <label class="form-check-label" th:for="${'required' + (questionSize + 1)}">필수 값
                                            설정</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input move-question-switch" type="checkbox"
                                               role="switch"
                                               th:id="${'moveQuestion' + (questionSize + 1)}"
                                               onclick="toggleMove(this)">
                                        <label class="form-check-label" th:for="${'moveQuestion' + (questionSize + 1)}">문항
                                            이동</label>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-dark" onclick="removeList(this)"><i
                                            data-feather="trash-2"></i>문항 삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="button-container">
                            <button type="button" class="btn btn-primary" onclick="surveyQuestionInsert()">등록하기</button>
                            <!--<a href="javascript:" class="btn btn-outline-primary" onclick="history.back();">목록보기</a>-->
                            <a th:href="@{/survey/list/{menuId}(menuId=${menuId})}"
                               class="btn btn-outline-primary">목록보기</a>
                            <button id="buttonAddList" type="button" class="btn btn-dark add-list"><i
                                    data-feather="plus"></i> 문항 추가
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>
<script>

    function makeQuestionList() {
        let errorMsg = "";
        let question_object_list = [];
        $(".question-body.on").each(function (idx) {
            let question_object = {};
            let question_no = 0;
            let question_type_no = $(this).attr("data-question-type");
            question_object["question_type_no"] = question_type_no;
            question_object["survey_no"] = $("input[name='survey_no']").val();
            question_object["question_title"] = $(this).find("input[name='question_title']").val();
            question_object["question_description"] = $(this).find("textarea[name='question_description']").val();
            question_object["required_yn"] = $(this).parent().find("input[name='required_yn']").prop("checked") ? "Y" : "N";
            question_object["question_order"] = idx + 1;
            if($(this).find("input[name='question_no']").length > 0) {
                question_no = $(this).find("input[name='question_no']").val();
                question_object["question_no"] = question_no;
            }

            if(question_type_no == 1){
                let choice_list = [];
                $(this).find(".item-list .item").each(function (choiceIdx) {
                    let choice_object = {};
                    choice_object["choice_content"] = $(this).find("input[name='choice_content']").val();

                    if($(this).find("input[name='question_choice_no']").length > 0) {
                        choice_object["question_choice_no"] = $(this).find("input[name='question_choice_no']").val();
                    }
                    if(question_no != 0){
                        choice_object["question_no"] = question_no;
                    }
                    if($(this).find(".move-question-type").val() == 1){
                        let move_question_no = $(this).find("input[name='move_question_no']").val();
                        if(!move_question_no) {
                            errorMsg = (idx + 1) + "번째 문항의 " + (choiceIdx + 1) + "번째 보기의 이동할 문항 번호를 입력해 주세요.";
                        }
                        else {
                            if(move_question_no < (idx + 1)){
                                errorMsg = (idx + 1) + "번째 문항의 " + (choiceIdx + 1) + "번째 보기의 이동할 문항 번호는 현재 문항보다 높은 번호를 입력해 주세요.";
                            }
                            choice_object["move_question_no"] = move_question_no;
                        }
                    }
                    else if($(this).find(".move-question-type").val() == 99){
                        choice_object["move_question_no"] = 99;
                    }
                    choice_list.push(choice_object);
                });
                if(choice_list.length == 0){
                    errorMsg = (idx + 1) + "번째 객관식 문항의 보기를 추가해 주세요.";
                }
                question_object["choices"] = choice_list;
            }
            question_object_list.push(question_object);
        });

        if(errorMsg != ""){
            alert(errorMsg);
            return false;
        }

        console.log(question_object_list);
    }

    function surveyQuestionInsert() {
        makeQuestionList();
        return;
        var qstn = $("#srvy_qstn1").val();
        if (qstn === null || qstn === '') {
            alert("질문을 입력해 주세요.")
            $("#srvy_qstn1").focus();
            return false;
        }

        let result = confirm("등록 하시겠습니까?");
        if (result) {
            const form = document.forms['qstn_form'];
            form.action = '/kbinnovationhub_devadm/survey/qstnInsert';   //전송할 URL
            form.method = 'POST';                                    //전송 방식
            form.target = '';                                        //새 창에서 열기
            form.submit();                                           //폼 제출
        }
    }

    $(function () {
        $('#buttonAddList').click(addList);
        // $('.select-type').on('change', changeType);
    });

    // 문항 추가
    function addList() {
        let questionCount = $(".question-list").length;

        if (questionCount >= 10) {
            alert("문항 추가는 10개 까지 가능 합니다");
            return true;
        }

        $('.question').append(`<div class="question-list">
                                <div class="question-head">
                                    <h3 class="heading h5"><i data-feather="check-circle"></i> 문항 ${questionCount + 1}</h3>
                                    <select class="form-select select-type"
                                            name="question_type_no" onchange="changeType(this)">
                                        <option value="1">객관식 질문</option>
                                        <option value="2">주관식 질문</option>
                                        <option value="3">첨부파일</option>
                                        <option value="4">에디터</option>
                                    </select>
                                </div>
                                <div class="question-body on"
                                     data-question-type="1">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" class="form-control" name="question_title"
                                                   value="" placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control" rows="5"
                                                      name="question_description"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div class="item-list">
                                            </div>
                                            <button type="button" class="btn btn-sm btn-dark add-item"
                                                    onclick="addItem(this)" data-idx="1">
                                                <i class="me-0" data-feather="plus"></i>
                                                보기 추가
                                            </button>
                                        </div>
                                    </div>

                                </div>
                                <div class="question-body"
                                     data-question-type="2">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" name="question_title" class="form-control" value="" placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control"
                                                      name="question_description" rows="5"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-body"
                                     data-question-type="3">
                                    <div class="row">
                                        <div class="col">
                                            <input type="text" name="question_title" class="form-control" value="" placeholder="질문을 입력해 주세요.">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <textarea class="form-control"
                                                      name="question_description" rows="5"
                                                      placeholder="질문에 대한 상세내용을 입력해 주세요."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-body"
                                     data-question-type="4">
                                    <div class="row">
                                        <div class="col">
                                            <div class="summernote-editor" id="summernote${questionCount + 1}"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="question-foot">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" name="required_yn" id="required${questionCount + 1}">
                                        <label class="form-check-label" for="required${questionCount + 1}">필수 값 설정</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input move-question-switch" type="checkbox" role="switch" id="moveQuestion${questionCount + 1}" onclick="toggleMove(this)">
                                        <label class="form-check-label" for="moveQuestion${questionCount + 1}">문항 이동</label>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-dark" onclick="removeList(this)"><i
                                            data-feather="trash-2"></i>문항 삭제
                                    </button>
                                </div>
                            </div>`);

        feather.replace();

        $('#summernote' + (questionCount + 1)).summernote({
            lang: 'ko-KR',
            height: 300
        });
    }

    $(".summernote-editor").summernote({
        lang: 'ko-KR',
        height: 300
    });


    // 문항 삭제
    function removeList(e) {
        const element = $(e);

        element.closest('.question-list').remove();
    }

    // 질문 유형 선택
    function changeType(e) {
        const type = e.value;

        e.closest('.question-list').querySelectorAll('.question-body').forEach(el => {
            el.classList.remove('on');
        })

        e.closest('.question-list').querySelector('[data-question-type="' + type + '"]').classList.add('on');
    }

    function addItem(el) {
        const $element = $(el);
        const itemListCount = $element.parent().find('.item-list').find(".item").length;
        if (itemListCount >= 10) {
            alert("보기는 10개까지 추가 가능합니다.");
            return;
        }

        const moveYn = $element.parent().parent().parent().parent().find(".move-question-switch").prop("checked");
        $element.parent().find(".item-list").append(`<div class="item">
                                                        <div class="column">
                                                            <input type="text" class="form-control form-control-sm" name="choice_content" placeholder="보기 ${itemListCount}">
                                                            <select class="form-select form-select-sm move-question-type ${moveYn ? 'on' : ''}">
                                                                <option value="0">다음 문항</option>
                                                                <option value="1">문항 번호 선택</option>
                                                                <option value="99">설문 제출</option>
                                                            </select>
                                                        </div>
                                                        <div class="column">
                                                            <button type="button" class="btn remove-item" onclick="removeItem(this)"><i data-feather="x-circle"></i></button>
                                                        </div>
                                                    </div>`);

    }

    $("body").on("change", ".move-question-type", function () {
        const value = $(this).val();
        if (value === "1") {
            $(this).parent().append(`<input type="number" class="form-control form-control-sm w-25" name="move_question_no" placeholder="이동할 문항 번호를 입력해 주세요.">`);
        } else {
            $(this).parent().find("input[name='move_question_no']").remove();
        }
    });


    // 보기 삭제
    function removeItem(e) {
        e.closest('.item').remove();
    }

    // 항목 이동 선택 토글
    function toggleMove(e) {
        const element = $(e);

        if (e.checked) {
            element.closest('.question-list').find('.form-select').each(function () {
                if ($(this).val() == 1) {
                    element.closest('.question-list').find('input[name="move_question_no"]').css("display", "block");
                }
            });
            element.closest('.question-list').find('.form-select').addClass('on')
        } else {
            element.closest('.question-list').find('.form-select').each(function () {
                if ($(this).val() != 1) {
                    element.closest('.question-list').find('input[name="move_question_no"]').css("display", "none");
                }
            });
            element.closest('.question-list').find('.form-select').removeClass('on')
        }
    }
</script>
<script th:src="@{/js/admin.js}"></script>

</body>
</html>